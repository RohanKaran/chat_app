<!DOCTYPE html>
<html lang="en">
<head>
  <title>Chat Room</title>
</head>
<body>
<style>
  .matched-user {
    color: green;
  }

  .other-user {
    color: blue;
  }
</style>
<div id="chat-log" style="height: 300px; overflow: auto; border: 1px solid #ccc;">
  <ul></ul>
</div>
<textarea id="chat-message-input" rows="3" cols="100"></textarea>
<button id="chat-message-submit">Send</button>
<button id="find-match">Find Match</button>
<script>
  let user_id = {{ user_id }};
  let chatSocket;

  function connectToRoom(roomName) {
    if (chatSocket) {
      chatSocket.close();
    }
    chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      if (data.message) {
        let newItem = document.createElement('li');
        newItem.textContent = data.message;
        if (data.user === user_id) {
          newItem.classList.add('matched-user');
        } else {
          newItem.classList.add('other-user');
        }
        document.querySelector('#chat-log ul').appendChild(newItem);
      }
    };

    chatSocket.onclose = function (e) {
      console.error('Chat socket closed unexpectedly');
    };


    document.querySelector('#chat-message-submit').onclick = function (e) {
      const messageInputDom = document.querySelector('#chat-message-input');
      const message = messageInputDom.value;
      chatSocket.send(JSON.stringify({
        'message': message
      }));
      messageInputDom.value = "";
    };
  }

  document.addEventListener('DOMContentLoaded', () => {
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      console.log(data)
      if (data.room_name) {
        console.log("Match found, joining room:", data.room_name);
        connectToRoom(data.room_name);
      } else if (data.error) {
        alert(data.error)
      }
    };

    chatSocket.onclose = function (e) {
      console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
      if (e.keyCode === 13) {  // enter, return
        document.querySelector('#chat-message-submit').click();
      }
    };
    document.querySelector('#find-match').onclick = function (e) {
      chatSocket.send(JSON.stringify({
        'action': 'find_match'
      }));
    };
  });

</script>
</body>
</html>
